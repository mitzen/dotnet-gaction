on:
  workflow_call:
    secrets:
      AZURE_CREDENTIALS:
        required: true   

    inputs:
      resource_group:
        required: true
        type: string

      cluster_name:
        required: true
        type: string
      
      container_registry:
        required: true
        type: string

      imageName:
        required: true
        type: string

      environment:
        required: true
        type: string

      chart_path:
        required: true
        type: string

      chart_version:
        type: string
        default: 'latest'
  
jobs:

 kubernetes-deploy:
   runs-on: ubuntu-latest
   environment: ${{ inputs.environment }}

   steps:
      -
        name: Checkout
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@14a755a4e2fd6dff25794233def4f2cf3f866955
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Gets K8s context
        uses: azure/aks-set-context@94ccc775c1997a3fcfbfbce3c459fec87e0ab188
        with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
            resource-group: ${{ inputs.resource_group }}
            cluster-name: ${{ inputs.cluster_name }}
        id: login

      - name: Configure deployment
        uses: azure/k8s-bake@61041e8c2f75c1f01186c8f05fb8b24e1fc507d8
        with:
          renderEngine: 'helm'
          helmChart: ${{ inputs.chart_path }}
          #overrideFiles: ${{ env.CHART_OVERRIDE_PATH }}
          # overrides: | 
          #   replicas:2
          helm-version: ${{ inputs.chart_version }} 
        id: prepare-chart

      - name: Deploys application
        uses: Azure/k8s-deploy@dd4bbd13a5abd2fc9ca8bdcb8aee152bb718fa78
        with:
          manifests: ${{ steps.prepare-chart.outputs.manifestsBundle }}
          images: |
            ${{ inputs.container_registry }}.azurecr.io/${{ inputs.imageName }}
          imagepullsecrets: |
            ${{ env.PROJECT_NAME }}